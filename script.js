document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. STATE MANAGEMENT ---
    let cvData = {
        layout: 'classic',
        themeColor: '#dc3545',
        avatar: { type: 'initials', value: 'HD' },
        personalInfo: { 
            firstName: 'Hector Daniel', 
            lastName: 'Ayarachi Fuentes', 
            title: 'Desarrollador de Software', 
            email: 'mp4o@hotmail.com', 
            phone: '2995056213', 
            address: 'Neuquen, Argentina', 
            website: 'linkedin.com/in/hector-daniel-ayarachi-fuentes/', 
            summary: 'Soy un desarrollador de software con una sólida experiencia en la creación de aplicaciones web escalables y eficientes. Mi enfoque principal se centra en el desarrollo backend, donde tengo un profundo conocimiento de Python y el ecosistema de AWS. Además, he trabajado en proyectos de DevOps para mejorar la eficiencia y la automatización de los procesos de desarrollo.' 
        },
        experience: [{ id: Date.now() + 1, position: 'Desarrollador Backend Senior', company: 'Tech Solutions Inc.', startDate: '2020-02', endDate: '', current: true, description: '- Lideré el desarrollo del microservicio de pagos.\n- Optimicé consultas a la base de datos, mejorando el rendimiento en un 40%.\n- Implementé pipelines de CI/CD con Jenkins y Docker.' }],
        education: [{ id: Date.now() + 2, degree: 'Ingeniería en Sistemas de Información', institution: 'Universidad Tecnológica Nacional', startDate: '2014-04', endDate: '2020-01', current: false, description: 'Proyecto final sobre optimización de redes neuronales.' }],
        skills: [{ id: Date.now() + 3, name: 'Python', level: 'expert' }, { id: Date.now() + 4, name: 'AWS', level: 'advanced' }, { id: Date.now() + 5, name: 'Docker', level: 'advanced' }, { id: Date.now() + 6, name: 'JavaScript', level: 'intermediate' }],
        footer: { text: 'Disponible para oportunidades de reubicación. Referencias disponibles a petición.' }
    };

    // --- 2. DOM ELEMENTS & CONFIG ---
    const navItems = document.querySelectorAll('.nav-item');
    const formWrapper = document.getElementById('form-section-wrapper');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const cvPreviewWrapper = document.getElementById('cv-preview-wrapper');
    const iconOptions = {
        code: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
        briefcase: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
        pen: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.8 2.8 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>`,
        chart: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
        lightbulb: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 18 9 18 7c0-2.2-1.8-4-4-4S9.8 3.5 8.5 5.1"/><path d="M9 18c-1.3 0-2.5-.5-3.5-1.4C3.8 15 3 13.1 3 11c0-2.5 2-4.5 4.5-4.5"/><path d="M15 22v-4.5C15 15.4 13.9 14 12 14s-3 .3-3 3.5V22"/><path d="M12 14h0"/></svg>`,
        target: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
        "graduation-cap": `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.084a1 1 0 0 0 0 1.838l8.57 3.908a2 2 0 0 0 1.66 0z"/><path d="M22 10v6"/><path d="M6 12v5c0 3 2.5 5 5 5s5-2 5-5v-5"/></svg>`,
        cog: `<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM12 2v2M12 22v-2M20 12h2M2 12h-2M19.78 4.22l-1.42 1.42M5.64 18.36l-1.42-1.42M19.78 19.78l-1.42-1.42M5.64 5.64L4.22 4.22"/></svg>`
    };
    
    // --- 3. TEMPLATE & FORM FUNCTIONS ---
    const templates = {}; 
    const formRenderers = {};

    (function buildTemplateAndFormFunctions(){
        const levelLabels = { beginner: 'Principiante', intermediate: 'Intermedio', advanced: 'Avanzado', expert: 'Experto' };
        
        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            const [year, month] = dateStr.split('-');
            return `${months[parseInt(month, 10) - 1]} ${year}`;
        };

        const formatExperienceDate = (startDate, endDate, isCurrent) => {
            const start = formatDate(startDate);
            const end = isCurrent ? 'Actual' : formatDate(endDate);
            if (!start) return '';
            return `${start} - ${end}`;
        };

        const getFullName = (p) => `${p.firstName || ''} ${p.lastName || ''}`.trim();

        const renderAvatar = (data) => {
            const { avatar } = data;
            if (!avatar) return '';
            switch (avatar.type) {
                case 'photo': case 'url': return `<img src="${avatar.value}" style="width:100%; height:100%; object-fit:cover;">`;
                case 'initials': return `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background-color:rgba(0,0,0,0.2); font-size:3rem; font-weight:bold; color: white;">${avatar.value || ''}</div>`;
                case 'icon': case 'svg': return `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background-color:rgba(0,0,0,0.2); padding: 20px; color: white;">${avatar.value || ''}</div>`;
                default: return `<div style="width:100%; height:100%; background-color:#e0e0e0; display:flex; align-items:center; justify-content:center;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9e9e9e" stroke-width="1"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>`;
            }
        };
        
        const renderFooter = (data, options = { color: '#555', borderColor: '#eee', bgColor: 'transparent', padding: '1rem 2.5rem' }) => {
            if (!data.footer || !data.footer.text) return '';
            return `<footer style="font-size:0.8rem; text-align:center; white-space:pre-wrap; color:${options.color}; background-color:${options.bgColor}; border-top:1px solid ${options.borderColor}; padding:${options.padding}; margin-top:auto;">${data.footer.text}</footer>`;
        };

        templates.classic = (data) => `<div id="cv-template" style="display:flex; height:100%;"><div style="width:35%;background-color:${data.themeColor};color:white;padding:2rem;display:flex;flex-direction:column;gap:2rem"><div style="width:130px;height:130px;border-radius:50%;overflow:hidden;margin:0 auto;border:4px solid white;flex-shrink:0;box-shadow:0 4px 10px rgba(0,0,0,0.3)">${renderAvatar(data)}</div><div><h3 style="font-size:1rem;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:.5rem;margin-bottom:1rem">CONTACTO</h3>${data.personalInfo.phone?`<p style="font-size:.75rem;margin-bottom:.7rem"><strong>Teléfono:</strong><br>${data.personalInfo.phone}</p>`:''}${data.personalInfo.email?`<p style="font-size:.75rem;margin-bottom:.7rem;word-break:break-all"><strong>Email:</strong><br>${data.personalInfo.email}</p>`:''}${data.personalInfo.address?`<p style="font-size:.75rem;margin-bottom:.7rem"><strong>Dirección:</strong><br>${data.personalInfo.address}</p>`:''}${data.personalInfo.website?`<p style="font-size:.75rem;word-break:break-all"><strong>Web:</strong><br><a href="https://${data.personalInfo.website}" target="_blank" style="color:white;text-decoration:none">${data.personalInfo.website}</a></p>`:''}</div>${data.skills.length>0?`<div><h3 style="font-size:1rem;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:.5rem;margin-bottom:1rem">HABILIDADES</h3>${data.skills.map(s=>`<p style="font-size:.8rem;margin-bottom:.4rem">${s.name}<span style="font-size:.7rem;opacity:.8"> (${levelLabels[s.level]})</span></p>`).join('')}</div>`:''}</div><div style="width:65%; color:#333; display:flex; flex-direction:column;"><div style="padding:2.5rem; flex-grow:1;"><h1 style="font-family: var(--font-heading); font-size:2.3rem;font-weight:700;color:${data.themeColor};line-height:1.2;margin-bottom:.2rem">${data.personalInfo.firstName || ''}<br>${data.personalInfo.lastName || ''}</h1><h2 style="font-family: var(--font-heading); font-size:1.1rem;font-weight:500;margin-bottom:1.5rem;border-bottom:1px solid #eee;padding-bottom:.75rem">${data.personalInfo.title||''}</h2>${data.personalInfo.summary?`<div><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:.75rem;display:inline-block">RESUMEN</h3><p style="font-size:.8rem;line-height:1.6;white-space:pre-wrap">${data.personalInfo.summary}</p></div>`:''}${data.experience.length>0?`<div style="margin-top:1.5rem"><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:1rem;display:inline-block">EXPERIENCIA</h3>${data.experience.map(e=>`<div style="margin-bottom:1.2rem"><div style="display:flex;justify-content:space-between;align-items:baseline"><h4 style="font-size:.9rem;font-weight:600">${e.position||''}</h4><p style="font-size:.75rem;font-weight:500;color:#555;white-space:nowrap;margin-left:1rem">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div><p style="font-size:.85rem;font-style:italic;margin-bottom:.3rem">${e.company||''}</p><p style="font-size:.8rem;white-space:pre-wrap;line-height:1.5">${e.description||''}</p></div>`).join('')}</div>`:''}${data.education.length>0?`<div style="margin-top:1.5rem"><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:1rem;display:inline-block">EDUCACIÓN</h3>${data.education.map(e=>`<div style="margin-bottom:1rem"><div style="display:flex;justify-content:space-between;align-items:baseline"><h4 style="font-size:.9rem;font-weight:600">${e.degree||''}</h4><p style="font-size:.75rem;font-weight:500;color:#555;white-space:nowrap;margin-left:1rem">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div><p style="font-size:.85rem;font-style:italic;margin-bottom:.3rem">${e.institution||''}</p><p style="font-size:.8rem;white-space:pre-wrap;line-height:1.5">${e.description||''}</p></div>`).join('')}</div>`:''}</div>${renderFooter(data)}</div></div>`;
        templates.modern = (data) => `<div id="cv-template" style="display:flex;flex-direction:column;height:100%"><header style="padding:2.5rem;display:flex;align-items:center;gap:2rem;border-bottom:2px solid ${data.themeColor}"><div style="width:120px;height:120px;border-radius:50%;overflow:hidden;flex-shrink:0;background-color:${data.themeColor}">${renderAvatar(data)}</div><div><h1 style="font-family: var(--font-heading); font-size:2.3rem;font-weight:700;color:#333;line-height:1.1">${getFullName(data.personalInfo)}</h1><h2 style="font-family: var(--font-heading); font-size:1.1rem;font-weight:500;color:${data.themeColor}">${data.personalInfo.title||''}</h2></div></header><main style="padding:2.5rem;flex-grow:1;display:grid;grid-template-columns:2.5fr 1fr;gap:2.5rem;overflow:hidden"><div>${data.personalInfo.summary?`<div><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:.75rem;display:inline-block">RESUMEN</h3><p style="font-size:.8rem;line-height:1.6;white-space:pre-wrap">${data.personalInfo.summary}</p></div>`:''}${data.experience.length>0?`<div style="margin-top:1.5rem"><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:1rem;display:inline-block">EXPERIENCIA</h3>${data.experience.map(e=>`<div style="margin-bottom:1.2rem"><div style="display:flex;justify-content:space-between;align-items:baseline"><h4 style="font-size:.9rem;font-weight:600">${e.position||''}</h4><p style="font-size:.75rem;font-weight:500;color:#555;white-space:nowrap;margin-left:1rem">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div><p style="font-size:.85rem;font-style:italic;margin-bottom:.3rem">${e.company||''}</p><p style="font-size:.8rem;white-space:pre-wrap;line-height:1.5">${e.description||''}</p></div>`).join('')}</div>`:''}${data.education.length>0?`<div style="margin-top:1.5rem"><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:1rem;display:inline-block">EDUCACIÓN</h3>${data.education.map(e=>`<div style="margin-bottom:1rem"><div style="display:flex;justify-content:space-between;align-items:baseline"><h4 style="font-size:.9rem;font-weight:600">${e.degree||''}</h4><p style="font-size:.75rem;font-weight:500;color:#555;white-space:nowrap;margin-left:1rem">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div><p style="font-size:.85rem;font-style:italic;margin-bottom:.3rem">${e.institution||''}</p><p style="font-size:.8rem;white-space:pre-wrap;line-height:1.5">${e.description||''}</p></div>`).join('')}</div>`:''}</div><div>${data.skills.length>0?`<div><h3 style="font-family: var(--font-heading); font-size:1rem;font-weight:600;color:${data.themeColor};border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:1rem;display:inline-block">HABILIDADES</h3>${data.skills.map(s=>`<p style="font-size:0.8rem;margin-bottom:.4rem">${s.name}<span style="font-size:.7rem;opacity:.8"> (${levelLabels[s.level]})</span></p>`).join('')}</div>`:''}</div></main>${renderFooter(data, {color: 'white', bgColor: data.themeColor, borderColor: data.themeColor, padding: '1.5rem 2.5rem'})}</div>`;
        templates.compact = (data) => `<div id="cv-template" style="padding:3rem;height:100%; display:flex; flex-direction:column;"><div style="flex-grow:1;"><header style="text-align:center;margin-bottom:2rem"><h1 style="font-size:2.5rem;font-weight:700;color:${data.themeColor}">${getFullName(data.personalInfo)}</h1><h2 style="font-size:1.2rem;font-weight:400;color:#444">${data.personalInfo.title||''}</h2></header><div style="text-align:center;font-size:.8rem;color:#555;margin-bottom:2rem;display:flex;justify-content:center;flex-wrap:wrap;gap:1.5rem">${data.personalInfo.phone?`<span>${data.personalInfo.phone}</span>`:''}${data.personalInfo.email?`<span>${data.personalInfo.email}</span>`:''}${data.personalInfo.address?`<span>${data.personalInfo.address}</span>`:''}${data.personalInfo.website?`<a href="https://${data.personalInfo.website}" style="color:${data.themeColor}">${data.personalInfo.website}</a>`:''}</div>${data.personalInfo.summary?`<section><h3 class="compact-h3" style="color:${data.themeColor}">RESUMEN</h3><p class="compact-p">${data.personalInfo.summary}</p></section>`:''}${data.experience.length>0?`<section style="margin-top:1.5rem"><h3 class="compact-h3" style="color:${data.themeColor}">EXPERIENCIA</h3>${data.experience.map(e=>`<div class="compact-item"><div class="compact-item-header"><h4 class="compact-h4">${e.position||''} en ${e.company||''}</h4><p class="compact-date">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div><p class="compact-p">${e.description||''}</p></div>`).join('')}</section>`:''}${data.education.length>0?`<section style="margin-top:1.5rem"><h3 class="compact-h3" style="color:${data.themeColor}">EDUCACIÓN</h3>${data.education.map(e=>`<div class="compact-item"><div class="compact-item-header"><h4 class="compact-h4">${e.degree||''} en ${e.institution||''}</h4><p class="compact-date">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div><p class="compact-p">${e.description||''}</p></div>`).join('')}</section>`:''}${data.skills.length>0?`<section style="margin-top:1.5rem"><h3 class="compact-h3" style="color:${data.themeColor}">HABILIDADES</h3><div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:0.75rem">${data.skills.map(s=>`<span style="background-color:#eee;padding:.3rem .8rem;border-radius:15px;font-size:.8rem">${s.name}</span>`).join('')}</div></section>`:''}</div>${renderFooter(data, { padding: '2rem 3rem 0 3rem'})}</div><style>.compact-h3{font-family: var(--font-heading); font-size:1.1rem;font-weight:600;border-bottom:2px solid ${data.themeColor};padding-bottom:.25rem;margin-bottom:.75rem}.compact-p{font-size:.85rem;line-height:1.6;white-space:pre-wrap;color:#333}.compact-item{margin-bottom:1rem;margin-top:.75rem}.compact-item-header{display:flex;justify-content:space-between}.compact-h4{font-size:.9rem;font-weight:600}.compact-date{font-size:.75rem;font-weight:500;color:#555}</style>`;
        templates.executive = (data) => `<div id="cv-template" style="padding:2.5rem;border:10px solid ${data.themeColor};height:100%; display:flex; flex-direction:column;"><div style="flex-grow:1;"><header style="text-align:center;margin-bottom:2.5rem;padding-bottom:1rem;border-bottom:1px solid #ccc"><div style="width:110px;height:110px;border-radius:50%;overflow:hidden;margin:0 auto 1rem auto;border:3px solid ${data.themeColor};background-color:${data.themeColor}">${renderAvatar(data)}</div><h1 style="font-family:var(--font-serif);font-size:2.8rem;font-weight:600;color:#222">${getFullName(data.personalInfo)}</h1><p style="font-size:1.1rem;color:${data.themeColor}">${data.personalInfo.title||''}</p></header><div style="display:grid;grid-template-columns:1fr 2fr;gap:2rem"><aside style="font-size:.8rem">${data.personalInfo.summary?`<section><h4 class="executive-h4">RESUMEN</h4><p style="white-space:pre-wrap">${data.personalInfo.summary}</p></section>`:''}${data.skills.length>0?`<section style="margin-top:1.5rem"><h4 class="executive-h4">HABILIDADES</h4>${data.skills.map(s=>`<p>${s.name}</p>`).join('')}</section>`:''}<section style="margin-top:1.5rem"><h4 class="executive-h4">CONTACTO</h4>${data.personalInfo.phone?`<p><strong>Tel:</strong> ${data.personalInfo.phone}</p>`:''}${data.personalInfo.email?`<p><strong>Email:</strong> ${data.personalInfo.email}</p>`:''}${data.personalInfo.address?`<p><strong>Dir:</strong> ${data.personalInfo.address}</p>`:''}${data.personalInfo.website?`<p><strong>Web:</strong> <a href="https://${data.personalInfo.website}" style="color:#444">${data.personalInfo.website}</a></p>`:''}</section></aside><main>${data.experience.length>0?`<section><h4 class="executive-h4">EXPERIENCIA</h4>${data.experience.map(e=>`<div class="executive-item"><h5>${e.position}</h5><p class="executive-sub">${e.company} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p class="executive-desc">${e.description}</p></div>`).join('')}</section>`:''}${data.education.length>0?`<section style="margin-top:1.5rem"><h4 class="executive-h4">EDUCACIÓN</h4>${data.education.map(e=>`<div class="executive-item"><h5>${e.degree}</h5><p class="executive-sub">${e.institution} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p class="executive-desc">${e.description}</p></div>`).join('')}</section>`:''}</main></div></div>${renderFooter(data, { padding: '2rem 0 0 0'})}</div><style>.executive-h4{font-family:var(--font-serif);font-size:1rem;font-weight:600;margin-bottom:.5rem;border-bottom:1px solid #ddd;padding-bottom:.2rem}.executive-item{margin-bottom:1rem}.executive-item h5{font-size:.9rem;font-weight:bold;margin:0}.executive-sub{color:#555;margin-bottom:.3rem}.executive-desc{font-size:.8rem;white-space:pre-wrap}</style>`;
        templates.creative = (data) => `<div id="cv-template" style="display:flex;height:100%"><aside style="width:10%;background:${data.themeColor};writing-mode:vertical-rl;text-orientation:mixed;display:flex;align-items:center;justify-content:center"><h1 style="color:white;font-size:3rem;text-transform:uppercase;letter-spacing:10px;transform:rotate(180deg); white-space:nowrap;">${data.personalInfo.firstName||''}</h1></aside><main style="width:90%;padding:2.5rem;display:flex;flex-direction:column;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem; flex-grow:1;"><div style="border-right:1px solid #eee;padding-right:2rem">${data.personalInfo.summary?`<div class="creative-section"><h2>RESUMEN</h2><p>${data.personalInfo.summary}</p></div>`:''}${data.experience.length>0?`<div class="creative-section"><h2>EXPERIENCIA</h2>${data.experience.map(e=>`<div class="creative-item"><h4>${e.position}</h4><p class="creative-sub">${e.company} | ${formatDate(e.startDate)}-${e.current?'Act.':formatDate(e.endDate)}</p><p class="creative-desc">${e.description}</p></div>`).join('')}</div>`:''}</div><div><h1 style="font-family: var(--font-heading); font-size:2rem;font-weight:bold">${data.personalInfo.lastName||''}</h1><p style="font-size:1.1rem;color:${data.themeColor};margin-bottom:1.5rem">${data.personalInfo.title||''}</p><div class="creative-section"><h4>CONTACTO</h4><p>${data.personalInfo.email||''}<br>${data.personalInfo.phone||''}<br>${data.personalInfo.address||''}</p></div>${data.skills.length>0?`<div class="creative-section"><h4>HABILIDADES</h4>${data.skills.map(s=>`<p>${s.name}</p>`).join('')}</div>`:''}${data.education.length>0?`<div class="creative-section"><h4>EDUCACIÓN</h4>${data.education.map(e=>`<p><b>${e.degree}</b><br>${e.institution}</p>`).join('')}</div>`:''}</div></div>${renderFooter(data, { padding: '2rem 0 0 0'})}</main></div><style>.creative-section{margin-bottom:1.5rem}.creative-section h2{font-family: var(--font-heading); font-weight:bold;color:${data.themeColor};margin-bottom:.5rem;font-size:1rem}.creative-section h4{font-weight:bold;margin-bottom:.2rem;font-size:.9rem}.creative-item{margin-bottom:.8rem}.creative-sub{font-size:.8rem;color:#666}.creative-desc,.creative-section p{font-size:.8rem;white-space:pre-wrap}</style>`;
        templates.minimalist = (data) => `<div id="cv-template" style="padding:4rem;background:white;color:#333;height:100%; display:flex; flex-direction:column;"><div style="flex-grow:1;"><header style="text-align:center;margin-bottom:3rem"><h1 style="font-size:3rem;font-weight:300;letter-spacing:4px">${getFullName(data.personalInfo).toUpperCase()}</h1><p style="font-size:1.1rem;margin-top:.5rem">${data.personalInfo.title||''}</p><p style="margin-top:1rem;font-size:.9rem">${data.personalInfo.email||''} | ${data.personalInfo.phone||''} | ${data.personalInfo.website||''}</p></header><main style="display:grid;grid-template-columns:1fr 2fr;gap:2rem;font-size:.9rem"><aside>${data.personalInfo.summary?`<h2 class="minimalist-h2">RESUMEN</h2><p style="white-space:pre-wrap">${data.personalInfo.summary}</p>`:''}</aside><div>${data.experience.length>0?`<h2 class="minimalist-h2">EXPERIENCIA</h2>${data.experience.map(e=>`<div class="minimalist-item"><h3>${e.position} | ${e.company}</h3><p class="minimalist-sub">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p style="white-space:pre-wrap">${e.description}</p></div>`).join('')}`:''}${data.education.length>0?`<h2 class="minimalist-h2">EDUCACIÓN</h2>${data.education.map(e=>`<div class="minimalist-item"><h3>${e.degree} | ${e.institution}</h3><p class="minimalist-sub">${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div>`).join('')}`:''}${data.skills.length>0?`<h2 class="minimalist-h2">HABILIDADES</h2><p>${data.skills.map(s=>s.name).join(', ')}</p>`:''}</div></main></div>${renderFooter(data, { padding: '3rem 0 0 0'})}</div><style>.minimalist-h2{font-family: var(--font-heading); font-size:1rem;font-weight:600;letter-spacing:2px;margin-bottom:1rem;border-bottom:1px solid #eee;padding-bottom:.5rem}.minimalist-item{margin-bottom:1rem}.minimalist-item h3{font-size:.9rem;font-weight:bold}.minimalist-sub{color:#777;margin-bottom:.3rem}</style>`;
        templates.corporate = (data) => `<div id="cv-template" style="display:flex; flex-direction:column; height:100%"><header style="background:${data.themeColor};color:white;padding:2rem;display:flex;align-items:center;gap:2rem"><div style="width:120px;height:120px;border-radius:.5rem;overflow:hidden;border:3px solid white;background-color:rgba(0,0,0,0.2); flex-shrink:0;">${renderAvatar(data)}</div><div><h1 style="font-size:2.5rem;font-weight:bold;line-height:1.2;">${data.personalInfo.firstName || ''}<br>${data.personalInfo.lastName || ''}</h1><p style="font-size:1.2rem">${data.personalInfo.title}</p></div></header><main style="padding:2rem;display:grid;grid-template-columns:1fr 2fr;gap:2rem;font-size:.9rem; flex-grow:1;"><aside style="font-size:.8rem"><h3 class="corporate-h3" style="color:${data.themeColor}">CONTACTO</h3><p>${data.personalInfo.email}<br>${data.personalInfo.phone}<br>${data.personalInfo.address}</p><h3 class="corporate-h3" style="margin-top:1.5rem;color:${data.themeColor}">HABILIDADES</h3>${data.skills.map(s=>`<div style="margin-bottom:.5rem"><p>${s.name}</p><div style="height:6px;background:#ddd;border-radius:3px"><div style="height:100%;width:${{'beginner':'25%','intermediate':'50%','advanced':'75%','expert':'100%'}[s.level]};background:${data.themeColor};border-radius:3px"></div></div></div>`).join('')}</aside><div>${data.personalInfo.summary?`<h3 class="corporate-h3" style="color:${data.themeColor}">RESUMEN</h3><p style="white-space:pre-wrap">${data.personalInfo.summary}</p><br>`:''}${data.experience.length>0?`<h3 class="corporate-h3" style="color:${data.themeColor}">EXPERIENCIA</h3>${data.experience.map(e=>`<div class="corporate-item"><h4 class="corporate-h4">${e.position}</h4><p class="corporate-sub">${e.company} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p style="white-space:pre-wrap">${e.description}</p></div>`).join('')}`:''}${data.education.length>0?`<h3 class="corporate-h3" style="margin-top:1.5rem;color:${data.themeColor}">EDUCACIÓN</h3>${data.education.map(e=>`<div class="corporate-item"><h4 class="corporate-h4">${e.degree}</h4><p class="corporate-sub">${e.institution} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p></div>`).join('')}`:''}</div></main>${renderFooter(data, { padding: '0 2rem 2rem 2rem'})}</div><style>.corporate-h3{font-family: var(--font-heading); font-size:.9rem;font-weight:bold;margin-bottom:.5rem;text-transform:uppercase}.corporate-item{margin-bottom:1rem}.corporate-h4{font-weight:bold;font-size:.9rem}.corporate-sub{color:#555;font-size:.8rem}</style>`;
        templates.technical = (data) => `<div id="cv-template" style="padding:2.5rem;font-family:var(--font-mono);height:100%; display:flex; flex-direction:column;"><div style="flex-grow:1;"><header style="display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid ${data.themeColor};padding-bottom:1rem"><div><h1 style="font-size:2rem;font-weight:600;color:${data.themeColor};line-height:1.2;">${data.personalInfo.firstName || ''}<br>${data.personalInfo.lastName || ''}</h1><p>${data.personalInfo.title}</p></div><div style="font-size:.8rem;text-align:right"><p>${data.personalInfo.email}</p><p>${data.personalInfo.phone}</p><p>${data.personalInfo.website}</p></div></header><main style="margin-top:1.5rem;font-size:.9rem">${data.personalInfo.summary?`<section class="tech-section"><h3 class="tech-h3" style="color:${data.themeColor}">// RESUMEN</h3><p class="tech-p">${data.personalInfo.summary}</p></section>`:''}${data.skills.length>0?`<section class="tech-section"><h3 class="tech-h3" style="color:${data.themeColor}">// HABILIDADES_CLAVE</h3><p class="tech-p">${data.skills.map(s=>`${s.name} (${levelLabels[s.level]})`).join(' | ')}</p></section>`:''}${data.experience.length>0?`<section class="tech-section"><h3 class="tech-h3" style="color:${data.themeColor}">// EXPERIENCIA</h3>${data.experience.map(e=>`<div class="tech-item"><h4 class="tech-h4">${e.position} @ ${e.company}</h4><p class="tech-sub">${formatDate(e.startDate)} -> ${e.current?'HEAD':formatDate(e.endDate)}</p><p class="tech-p">${e.description}</p></div>`).join('')}</section>`:''}${data.education.length>0?`<section class="tech-section"><h3 class="tech-h3" style="color:${data.themeColor}">// EDUCACIÓN</h3>${data.education.map(e=>`<div class="tech-item"><h4 class="tech-h4">${e.degree}</h4><p>${e.institution}</p></div>`).join('')}</section>`:''}</main></div>${renderFooter(data, { padding: '2rem 0 0 0' })}</div><style>.tech-section{margin-top:1.5rem}.tech-h3{font-family: var(--font-heading); font-size:1rem;margin-bottom:.5rem}.tech-h4{font-size:.9rem;margin:0}.tech-item{margin-bottom:1rem}.tech-sub{color:#666;font-size:.8rem}.tech-p{font-size:.85rem;line-height:1.6;white-space:pre-wrap}</style>`;
        templates.infographic = (data) => `<div id="cv-template" style="display:flex;height:100%"><aside style="width:38%;background-color:color-mix(in srgb, ${data.themeColor} 95%, #000);color:white;padding:2.5rem 2rem;display:flex;flex-direction:column;gap:2rem"><div style="text-align:center"><div style="width:140px;height:140px;border-radius:50%;overflow:hidden;margin:0 auto 1rem;border:5px solid white">${renderAvatar(data)}</div><h1 style="font-size:1.8rem;line-height:1.2;font-weight:700">${data.personalInfo.firstName}</h1><h1 style="font-size:1.8rem;line-height:1.2;font-weight:700">${data.personalInfo.lastName}</h1><p style="color:rgba(255,255,255,0.8);margin-top:0.3rem">${data.personalInfo.title}</p></div><div class="info-section"><h3>CONTACTO</h3>${data.personalInfo.email?`<p><svg width="14" viewBox="0 0 24 24"><path fill="currentColor" d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5l-8-5h16z"/></svg>${data.personalInfo.email}</p>`:''}${data.personalInfo.phone?`<p><svg width="14" viewBox="0 0 24 24"><path fill="currentColor" d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24c1.12.37 2.33.57 3.57.57c.55 0 1 .45 1 1V20c0 .55-.45 1-1 1c-9.39 0-17-7.61-17-17c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1c0 1.25.2 2.45.57 3.57c.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>${data.personalInfo.phone}</p>`:''}${data.personalInfo.website?`<p><svg width="14" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zM11 19.93c-3.95-.49-7-3.85-7-7.93c0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1h-2v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41c0 2.08-.8 3.97-2.1 5.39z"/></svg>${data.personalInfo.website}</p>`:''}</div>${data.skills.length>0?`<div class="info-section"><h3>HABILIDADES</h3>${data.skills.map(s=>`<div class="skill-bar"><p>${s.name}</p><div style="width:${{'beginner':'25%','intermediate':'50%','advanced':'75%','expert':'100%'}[s.level]}"></div></div>`).join('')}</div>`:''}</aside><div style="width:62%; display:flex; flex-direction:column;"><main style="padding:2.5rem; flex-grow:1;">${data.personalInfo.summary?`<section class="main-section"><h2><svg width="20" viewBox="0 0 24 24"><path fill="${data.themeColor}" d="M20 3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM12 9c1.1 0 2 .9 2 2s-.9 2-2 2s-2-.9-2-2s.9-2 2-2zm0 8c-2.21 0-4-1.79-4-4s1.79-4 4-4s4 1.79 4 4s-1.79 4-4 4z"/></svg>RESUMEN</h2><p>${data.personalInfo.summary}</p></section>`:''}${data.experience.length>0?`<section class="main-section"><h2><svg width="20" viewBox="0 0 24 24"><path fill="${data.themeColor}" d="M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-6 0h-4V4h4v2z"/></svg>EXPERIENCIA</h2>${data.experience.map(e=>`<div class="item"><h4>${e.position}</h4><p class="sub">${e.company} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p class="desc">${e.description}</p></div>`).join('')}</section>`:''}${data.education.length>0?`<section class="main-section"><h2><svg width="20" viewBox="0 0 24 24"><path fill="${data.themeColor}" d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6l9-4.91V17h2V9L12 3z"/></svg>EDUCACIÓN</h2>${data.education.map(e=>`<div class="item"><h4>${e.degree}</h4><p class="sub">${e.institution} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p class="desc">${e.description}</p></div>`).join('')}</section>`:''}</main>${renderFooter(data)}</div></div><style>.info-section h3{text-transform:uppercase;letter-spacing:1px;font-size:1rem;margin-bottom:0.8rem;border-bottom:1px solid rgba(255,255,255,0.3);padding-bottom:0.4rem}.info-section p{display:flex;align-items:center;gap:0.7rem;margin-bottom:0.5rem;font-size:0.8rem}.skill-bar{margin-bottom:0.6rem}.skill-bar p{margin:0 0 0.3rem;font-size:0.8rem}.skill-bar div{height:6px;border-radius:3px;background:white;width:100%}.skill-bar div > div{height:100%;background:${data.themeColor};border-radius:3px}.main-section{margin-bottom:2rem}.main-section h2{display:flex;align-items:center;gap:0.5rem;font-size:1.1rem;color:${data.themeColor};margin-bottom:1rem;border-bottom:2px solid ${data.themeColor};padding-bottom:0.3rem}.main-section p{font-size:0.85rem;white-space:pre-wrap}.item{margin-bottom:1rem}.item h4{font-size:0.95rem;font-weight:600}.item .sub{font-size:0.8rem;color:#555;margin-bottom:0.3rem}.item .desc{font-size:0.8rem}</style>`;
        templates.academic = (data) => `<div id="cv-template" style="padding:3rem;font-size:11pt;line-height:1.6;color:#333;height:100%; display:flex; flex-direction:column;"><div style="flex-grow:1;"><header style="text-align:center;margin-bottom:2rem"><h1 style="font-family:var(--font-serif);font-size:2.5rem;font-weight:600;margin:0">${getFullName(data.personalInfo)}</h1><p style="font-size:1.2rem;margin-top:0.2rem;color:${data.themeColor}">${data.personalInfo.title}</p><p style="font-size:0.9rem;margin-top:1rem">${data.personalInfo.email} | ${data.personalInfo.phone} | ${data.personalInfo.address}</p></header>${data.personalInfo.summary?`<section class="academic-section"><h3>Resumen Profesional</h3><p>${data.personalInfo.summary}</p></section>`:''}${data.experience.length>0?`<section class="academic-section"><h3>Experiencia Profesional</h3>${data.experience.map(e=>`<div class="academic-item"><h4>${e.position}</h4><p class="sub">${e.company} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p>${e.description}</p></div>`).join('')}</section>`:''}${data.education.length>0?`<section class="academic-section"><h3>Educación</h3>${data.education.map(e=>`<div class="academic-item"><h4>${e.degree}</h4><p class="sub">${e.institution} | ${formatExperienceDate(e.startDate,e.endDate,e.current)}</p><p>${e.description}</p></div>`).join('')}</section>`:''}${data.skills.length>0?`<section class="academic-section"><h3>Habilidades</h3><p>${data.skills.map(s=>s.name).join(' &bull; ')}</p></section>`:''}</div>${renderFooter(data, { padding: '2rem 0 0 0'})}</div><style>.academic-section{margin-bottom:1.5rem}.academic-section h3{font-family:var(--font-serif);font-size:1.1rem;font-weight:bold;border-bottom:1px solid #ccc;padding-bottom:0.3rem;margin-bottom:0.8rem}.academic-section p{margin:0;white-space:pre-wrap}.academic-item{margin-bottom:1rem}.academic-item h4{font-size:1rem;font-weight:bold;margin:0}.academic-item .sub{color:#555;font-style:italic;margin-bottom:0.2rem}</style>`;

        formRenderers.welcome = () => renderForm(`<div class="form-section" data-section="welcome"><h2 class="section-title">¡Bienvenido al Generador de CV Pro!</h2><p class="section-subtitle">Sigue estos sencillos pasos para crear tu currículum profesional.</p><div style="margin-top:2rem; display:flex; flex-direction:column; gap:1.5rem;"><div style="display:flex; gap:1rem;"><div style="flex-shrink:0; width:32px; height:32px; border-radius:50%; background:var(--primary-accent); color:white; display:grid; place-items:center; font-weight:bold;">1</div><div><h3 style="margin:0 0 0.2rem 0;">Personaliza el Diseño</h3><p style="color:var(--color-muted-text);">Ve a la sección "Diseño" para elegir una plantilla y tu color favorito.</p></div></div><div style="display:flex; gap:1rem;"><div style="flex-shrink:0; width:32px; height:32px; border-radius:50%; background:var(--primary-accent); color:white; display:grid; place-items:center; font-weight:bold;">2</div><div><h3 style="margin:0 0 0.2rem 0;">Completa las Secciones</h3><p style="color:var(--color-muted-text);">Usa la navegación para rellenar tu avatar, experiencia, educación y habilidades.</p></div></div><div style="display:flex; gap:1rem;"><div style="flex-shrink:0; width:32px; height:32px; border-radius:50%; background:var(--primary-accent); color:white; display:grid; place-items:center; font-weight:bold;">3</div><div><h3 style="margin:0 0 0.2rem 0;">Descarga y Triunfa</h3><p style="color:var(--color-muted-text);">Cuando estés listo, presiona "Descargar PDF" para obtener tu CV profesional.</p></div></div></div></div>`);
        formRenderers.design = () => { const hexColor = cvData.themeColor.startsWith('#') ? cvData.themeColor : '#525f7f'; renderForm(`<div class="form-section" data-section="design"><h2 class="section-title">Diseño y Apariencia</h2><p class="section-subtitle">Personaliza cómo se ve tu currículum.</p><div class="subsection-title">Color de Acento</div><div class="theme-selector"><div class="colors"><div class="color-dot ${cvData.themeColor==='#0d6efd'?'active':''}" data-color-value="#0d6efd" style="background:#0d6efd"></div><div class="color-dot ${cvData.themeColor==='#198754'?'active':''}" data-color-value="#198754" style="background:#198754"></div><div class="color-dot ${cvData.themeColor==='#6f42c1'?'active':''}" data-color-value="#6f42c1" style="background:#6f42c1"></div><div class="color-dot ${cvData.themeColor==='#dc3545'?'active':''}" data-color-value="#dc3545" style="background:#dc3545"></div><div class="color-dot ${cvData.themeColor==='#525f7f'?'active':''}" data-color-value="#525f7f" style="background:#525f7f"></div><input type="color" id="custom-color-picker" value="${hexColor}"></div></div><div class="subsection-title">Plantilla del CV</div><div class="layout-selector"><div class="layout-card ${cvData.layout==='classic'?'active':''}" data-layout="classic"><img src="https://i.imgur.com/rXBi2JN.png"><p>Clásico</p></div><div class="layout-card ${cvData.layout==='modern'?'active':''}" data-layout="modern"><img src="https://i.imgur.com/6ZweVTE.png"><p>Moderno</p></div><div class="layout-card ${cvData.layout==='compact'?'active':''}" data-layout="compact"><img src="https://i.imgur.com/vHExj4B.png"><p>Compacto</p></div><div class="layout-card ${cvData.layout==='executive'?'active':''}" data-layout="executive"><img src="https://i.imgur.com/H0nJtVf.png"><p>Ejecutivo</p></div><div class="layout-card ${cvData.layout==='creative'?'active':''}" data-layout="creative"><img src="https://i.imgur.com/152eA6A.png"><p>Creativo</p></div><div class="layout-card ${cvData.layout==='minimalist'?'active':''}" data-layout="minimalist"><img src="https://i.imgur.com/uC5iF5v.png"><p>Minimalista</p></div><div class="layout-card ${cvData.layout==='corporate'?'active':''}" data-layout="corporate"><img src="https://i.imgur.com/v8CoKg4.png"><p>Corporativo</p></div><div class="layout-card ${cvData.layout==='technical'?'active':''}" data-layout="technical"><img src="https://i.imgur.com/39w8A1N.png"><p>Técnico</p></div><div class="layout-card ${cvData.layout==='infographic'?'active':''}" data-layout="infographic"><img src="https://i.imgur.com/8Qp4kXm.png"><p>Infográfico</p></div><div class="layout-card ${cvData.layout==='academic'?'active':''}" data-layout="academic"><img src="https://i.imgur.com/p51aSP9.png"><p>Académico</p></div></div></div>`);};
        formRenderers.avatar = () => {const { type, value } = cvData.avatar || {type:'initials', value:''};renderForm(`<div class="form-section" data-section="avatar"><h2 class="section-title">Tu Avatar Profesional</h2><p class="section-subtitle">Elige cómo quieres presentarte.</p><div class="avatar-tabs"><div class="avatar-tab ${type==='photo'?'active':''}" data-type="photo">Foto</div><div class="avatar-tab ${type==='url'?'active':''}" data-type="url">URL Imagen</div><div class="avatar-tab ${type==='initials'?'active':''}" data-type="initials">Iniciales</div><div class="avatar-tab ${type==='icon'?'active':''}" data-type="icon">Icono</div><div class="avatar-tab ${type==='svg'?'active':''}" data-type="svg">Código SVG</div></div><div class="avatar-content ${type==='photo'?'active':''}" data-content="photo"><div style="display:flex;align-items:center;gap:1rem;"><img id="photo-preview" src="${type==='photo'&&value?value:'https://via.placeholder.com/120/e9ecef/6c757d?text=Foto'}"><div style="display:flex;flex-direction:column;gap:0.5rem;"><label for="photo-input" class="btn btn-secondary">Seleccionar Archivo</label><input type="file" id="photo-input" style="display:none;" accept="image/*">${type==='photo'&&value?'<button id="remove-photo-btn" class="btn">Eliminar Foto</button>':''}</div></div></div><div class="avatar-content ${type==='url'?'active':''}" data-content="url"><div class="form-group"><label for="image-url-input">URL de la imagen</label><input type="text" id="image-url-input" value="${type==='url'?value:''}" placeholder="https://ejemplo.com/foto.jpg"></div></div><div class="avatar-content ${type==='initials'?'active':''}" data-content="initials"><div class="form-group"><label for="initials-input">Tus Iniciales (1-3 caracteres)</label><input type="text" id="initials-input" maxlength="3" value="${type==='initials'?value:''}" placeholder="HD"></div></div><div class="avatar-content ${type==='icon'?'active':''}" data-content="icon"><p>Elige un ícono:</p><div class="icon-selector">${Object.entries(iconOptions).map(([key,svg])=>`<div class="icon-option ${type==='icon' && value===svg ? 'active' : ''}" data-icon-key="${key}">${svg}</div>`).join('')}</div></div><div class="avatar-content ${type==='svg'?'active':''}" data-content="svg"><div class="form-group"><label for="svg-code-input">Código SVG</label><textarea id="svg-code-input" placeholder='<svg width="24" ...></svg>' rows="5">${type==='svg'?value:''}</textarea></div></div></div>`);};
        formRenderers.personal = () => {const p=cvData.personalInfo;renderForm(`<div class="form-section" data-section="personal"><h2 class="section-title">Información Personal</h2><p class="section-subtitle">Los datos básicos para que puedan contactarte.</p><div class="form-grid"><div class="form-group"><label>Nombre(s)</label><input type="text" name="firstName" value="${p.firstName||''}"></div><div class="form-group"><label>Apellidos</label><input type="text" name="lastName" value="${p.lastName||''}"></div></div><div class="form-group"><label>Profesión</label><input type="text" name="title" value="${p.title||''}"></div><div class="form-grid"><div class="form-group"><label>Email</label><input type="email" name="email" value="${p.email||''}"></div><div class="form-group"><label>Teléfono</label><input type="tel" name="phone" value="${p.phone||''}"></div></div><div class="form-group"><label>Dirección</label><input type="text" name="address" value="${p.address||''}"></div><div class="form-group"><label>Web (sin https://)</label><input type="text" name="website" value="${p.website||''}"></div><div class="form-group"><label>Resumen</label><textarea name="summary" rows="5">${p.summary||''}</textarea></div></div>`)};
        formRenderers.skills = () => {renderForm(`<div class="form-section" data-section="skills"><h2 class="section-title">Habilidades</h2><p class="section-subtitle">Añade las tecnologías y competencias que dominas.</p><form id="skills-form" style="display:flex; gap:1rem; align-items:flex-end; margin-bottom:1.5rem;"><div class="form-group" style="flex-grow:1; margin-bottom:0;"><label for="skillName">Habilidad</label><input id="skillName" placeholder="Python..."></div><div class="form-group" style="margin-bottom:0;"><label for="skillLevel">Nivel</label><select id="skillLevel"><option value="expert">Experto</option><option value="advanced">Avanzado</option><option value="intermediate">Intermedio</option><option value="beginner">Principiante</option></select></div><button type="submit" class="btn btn-secondary" style="height:fit-content;">+ Añadir</button></form><hr style="margin:1.5rem 0;border:none;border-top:1px solid var(--color-border);"><div class="skills-list">${cvData.skills.map(s=>`<div class="skill-badge" data-id="${s.id}">${s.name}<button class="btn-delete" data-action="delete" data-section="skills" data-id="${s.id}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div>`).join('')}</div></div>`)};
        const dynamicListRenderer = (section, config) => {renderForm(`<div class="form-section" data-section="${section}"><h2 class="section-title">${config.title}</h2><p class="section-subtitle">${config.subtitle}</p><div class="add-item-container"><button class="btn btn-secondary" data-action="add" data-section="${section}">+ Añadir ${config.singularTitle}</button></div><div class="dynamic-list">${cvData[section].map(item=>`<div class="item" data-id="${item.id}"><div class="item-header"><h4>${item.position||item.degree||'Nuevo Elemento'}</h4><button class="btn-delete" data-action="delete" data-section="${section}" data-id="${item.id}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div><div class="form-grid"><div class="form-group"><label>${config.field1}</label><input type="text" name="${config.name1}" value="${item[config.name1]||''}"></div><div class="form-group"><label>${config.field2}</label><input type="text" name="${config.name2}" value="${item[config.name2]||''}"></div></div><div class="form-grid"><div class="form-group"><label>Fecha Inicio</label><input type="month" name="startDate" value="${item.startDate||''}"></div><div class="form-group"><label>Fecha Fin</label><input type="month" name="endDate" value="${item.endDate||''}" ${item.current?'disabled':''}></div></div><div class="form-group" style="font-size:.9rem;"><label style="display:flex;align-items:center;gap:.5rem;"><input type="checkbox" name="current" ${item.current?'checked':''}> Actualmente aquí</label></div><div class="form-group"><label>Descripción</label><textarea name="description" rows="4">${item.description||''}</textarea></div></div>`).join('')}</div></div>`);}
        formRenderers.experience = () => dynamicListRenderer('experience', {title:'Experiencia Laboral', singularTitle: 'Experiencia', subtitle:'Describe tus roles anteriores.', field1:'Cargo', name1:'position', field2:'Empresa', name2:'company'});
        formRenderers.education = () => dynamicListRenderer('education', {title:'Educación', singularTitle: 'Formación', subtitle:'Tu formación académica.', field1:'Título', name1:'degree', field2:'Institución', name2:'institution'});
        formRenderers.footer = () => {renderForm(`<div class="form-section" data-section="footer"><h2 class="section-title">Footer Personalizado</h2><p class="section-subtitle">Añade información adicional al pie de página de tu CV.</p><div class="form-group"><label>Texto del Footer</label><textarea name="text" rows="4">${cvData.footer.text||''}</textarea></div></div>`)};

    })();

    // --- 4. CORE FUNCTIONS ---
    const renderForm = (html) => {
        formWrapper.innerHTML = html;
        requestAnimationFrame(() => formWrapper.querySelector('.form-section')?.classList.add('active'));
    };
    const renderCVPreview = () => {
        const themeColor = cvData.themeColor || '#525f7f';
        document.documentElement.style.setProperty('--primary-accent', themeColor);
        const layout = cvData.layout || 'classic';
        cvPreviewWrapper.dataset.layout = layout;
        const templateFn = templates[layout] || templates.classic;
        cvPreviewWrapper.innerHTML = templateFn(cvData);
    };
    const setActiveSection = (sectionName) => {
        if (!sectionName) return;
        navItems.forEach(item => item.classList.toggle('active', item.getAttribute('href') === `#${sectionName}`));
        formRenderers[sectionName]?.();
    };

    // --- 5. INITIALIZATION & EVENT LISTENERS ---
    function init() {
        downloadPdfBtn.addEventListener('click', () => window.print());
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                setActiveSection(item.getAttribute('href').substring(1));
            });
        });
        formWrapper.addEventListener('input', (e) => {
            const { target } = e; 
            const section = target.closest('.form-section')?.dataset.section; 
            if (!section) return;
            if (section === 'personal') {
                cvData.personalInfo[target.name] = target.value;
            } else if (section === 'footer') {
                cvData.footer[target.name] = target.value;
            } else if (section === 'experience' || section === 'education') {
                const itemEl = target.closest('.item');
                const item = cvData[section].find(i => i.id == itemEl.dataset.id);
                if (item) {
                    item[target.name] = target.type === 'checkbox' ? target.checked : target.value;
                    if (target.name === 'current') {
                        const endDateInput = itemEl.querySelector('input[name="endDate"]');
                        if (endDateInput) endDateInput.disabled = target.checked;
                        if (target.checked) item.endDate = '';
                    }
                }
            } else if (section === 'design' && target.id === 'custom-color-picker') {
                cvData.themeColor = target.value;
            } else if (section === 'avatar') {
                if (target.id === 'initials-input') cvData.avatar = { type: 'initials', value: target.value.toUpperCase() };
                if (target.id === 'image-url-input') cvData.avatar = { type: 'url', value: target.value };
                if (target.id === 'svg-code-input') cvData.avatar = { type: 'svg', value: target.value };
            }
            renderCVPreview();
        });
        formWrapper.addEventListener('click', (e) => {
            const button = e.target.closest('button, .avatar-tab, .icon-option, .layout-card, .color-dot');
            if (!button) return;
            const section = button.dataset.section || button.closest('.form-section')?.dataset.section;
            const action = button.dataset.action || 
                           (button.classList.contains('avatar-tab') && 'switchTab') || 
                           (button.classList.contains('icon-option') && 'selectIcon') || 
                           (button.id === 'remove-photo-btn' && 'removePhoto') || 
                           (button.classList.contains('layout-card') && 'selectLayout') || 
                           (button.classList.contains('color-dot') && 'selectColor');
            
            if (action) {
                let needsRerender = true;
                switch(action) {
                    case 'add': cvData[section].push({ id: Date.now(), description: '' }); break;
                    case 'delete': cvData[section] = cvData[section].filter(i => i.id != button.dataset.id); break;
                    case 'switchTab': const newType = button.dataset.type; if (cvData.avatar.type !== newType) { cvData.avatar.type = newType; cvData.avatar.value = ''; } break;
                    case 'selectIcon': cvData.avatar = { type: 'icon', value: iconOptions[button.dataset.iconKey] }; break;
                    case 'removePhoto': cvData.avatar = { type: 'photo', value: '' }; break;
                    case 'selectLayout': cvData.layout = button.dataset.layout; break;
                    case 'selectColor': cvData.themeColor = button.dataset.colorValue; break;
                    default: needsRerender = false;
                }
                
                if(needsRerender && section) setActiveSection(section);
                renderCVPreview();
            }
        });
        formWrapper.addEventListener('submit', (e) => {
            if (e.target.id === 'skills-form') {
                e.preventDefault();
                const nameInput = e.target.querySelector('#skillName');
                const level = e.target.querySelector('#skillLevel').value;
                if (nameInput.value.trim()) {
                    cvData.skills.push({ id: Date.now(), name: nameInput.value.trim(), level });
                    setActiveSection('skills');
                    renderCVPreview();
                }
            }
        });
        formWrapper.addEventListener('change', (e) => {
            if (e.target.id === 'photo-input' && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    cvData.avatar = { type: 'photo', value: event.target.result };
                    setActiveSection('avatar');
                    renderCVPreview();
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
        setActiveSection('design');
        renderCVPreview();
    }

    init();
});
